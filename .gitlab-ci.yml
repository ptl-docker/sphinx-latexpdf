# Build a Docker container according to the Dockerfile, and publish it to the Container Registry

stages:
  - build
  - test

docker-build:
  # Use official docker image
  image: docker:latest
  stage: build
  services:
    - docker:dind
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker build --pull -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" .
    - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
  when: manual

test:
  #image: registry.gitlab.com/ptl-development/docker/sphinx-latexpdf:$CI_COMMIT_REF_SLUG
  image: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  stage: test
  before_script:
    # Add extra packages to handle svg files (these must be converted to pdf)
    - apt update && apt -y install inkscape
  script:
    # Get installed version numbers
    - sphinx-build --version
    - tex --version
    # Make a simple Sphinx workspace and build for latex
    - mkdir SphinxTest
    - cd SphinxTest
    - sphinx-quickstart -q -p MyProject -a Snoopy -v 0.1
    - make latexpdf
    ####TESTTEST
    - DISPLAY= inkscape image.svg --export-pdf=image.pdf
    - inkscape image.svg --export-pdf=image.pdf
  when: manual
  artifacts:
    paths:
      - SphinxTest/_build/latex/MyProject.pdf
      - image.pdf
