# Build a Docker container according to the Dockerfile, and publish it to the Container Registry

stages:
  - build-GitLab
  - build-DockerHub
  - test

build-GitLab:
  image: docker:latest
  stage: build-GitLab
  services:
    - docker:dind
  script:
    - docker login -u "$CI_REGISTRY_USER" -p "$CI_REGISTRY_PASSWORD" $CI_REGISTRY
    - docker build --pull -t "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG" .
    - docker push "$CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG"
  when: manual

build-DockerHub:
  image: docker:latest
  stage: build-DockerHub
  services:
    - docker:dind
  script:
    - docker login -u "$PTL_DOCKERHUB_USER" -p "$PTL_DOCKERHUB_PASSWORD" registry-1.docker.io
    - docker build --pull -t "pathwaytechnologies/sphinx-latexpdf:$CI_COMMIT_REF_SLUG" .
    - docker push "pathwaytechnologies/sphinx-latexpdf:$CI_COMMIT_REF_SLUG"
  when: manual

test:
  #image: registry.gitlab.com/ptl-development/docker/sphinx-latexpdf:$CI_COMMIT_REF_SLUG
  image: $CI_REGISTRY_IMAGE:$CI_COMMIT_REF_SLUG
  stage: test
  script:
    # Get installed version numbers
    - sphinx-build --version
    - tex --version
    - inkscape --version
    # Build the Sphinx project for latexpdf
    - cd testdoc
    - make latexpdf
  when: manual
  artifacts:
    paths:
      - testdoc/_build/latex/testdoc.pdf
